from telegram.ext import Application
from telegram.ext import MessageHandler
from telegram.ext import filters
from telegram.ext import CallbackQueryHandler
from telegram.ext import CommandHandler
from telegram import InlineKeyboardMarkup
from telegram import InlineKeyboardButton
from telegram import ReplyKeyboardMarkup
from telegram import ReplyKeyboardRemove
import random
import logging

TOWNS = ['Moscow', 'Saint Peterburg']
PHOTOS = {'Moscow': ['Moscow_1.jpg'], 'Saint Peterburg': ['Saint_peterburg_1.jpg']}
NAME_TOWNS = {'Moscow': "–ú–æ—Å–∫–≤–∞", 'Saint Peterburg': '–°–∞–Ω–∫—Ç –ü–µ—Ç–µ—Ä–±—É—Ä–≥'}

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.DEBUG)

logger = logging.getLogger(__name__)

reply_keyboard = [['üéÆ play üéÆ', '‚öôÔ∏è settings ‚öôÔ∏è'], ['üìä statistics üìä', 'üìñ faq üìñ']]
markup = ReplyKeyboardMarkup(reply_keyboard, resize_keyboard=True, one_time_keyboard=False)


async def start(update, context):
    await update.message.reply_text(
        "–Ø –±–æ—Ç-–∏–≥—Ä–∞! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –∏–≥—Ä—ã!",
        reply_markup=markup
    )
    return context


async def close_keyboard(update, context):
    await update.message.reply_text(
        "–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∑–∞–∫—Ä—ã—Ç–∞. –ò—Å–ø–æ—å–∑—É–π—Ç–µ /start –¥–ª—è –µ—ë –∑–∞–ø—É—Å–∫–∞!",
        reply_markup=ReplyKeyboardRemove())
    return context


async def helpp(update, context):
    await update.message.reply_text("–Ø –±–æ—Ç, –∫–æ–º–∞–Ω–¥–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.")
    return context


async def stat(update, context):
    await update.message.reply_text("–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.")
    return context


async def play(update, context):
    town = random.choice(TOWNS)
    photo = random.choice(PHOTOS[town])
    await update.message.reply_text("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ. –£–≥–∞–¥–∞–π—Ç–µ –≥–æ—Ä–æ–¥ –ø–æ —Ñ–æ—Ç–æ:")
    await update.message.reply_photo(rf'Russia cities\{town}\{photo}')
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:")
    context.user_data['locality'] = [NAME_TOWNS[town]]
    context.user_data['isgame'] = 'wait town'


async def first_response(update, context):
    context.user_data['locality'] = context.user_data['locality'] + [update.message.text]
    s = context.user_data['locality']
    await update.message.reply_text(f'–í—ã —É–≥–∞–¥–∞–ª–∏ –≥–æ—Ä–æ–¥ - {s[0]}\n–æ—Ü–µ–Ω–∏—Ç–µ –∏–≥—Ä—É –æ—Ç 1 –¥–æ 5' if s[0] == s[
        1] else f'–í—ã –Ω–µ —É–≥–∞–¥–∞–ª–∏ –≥–æ—Ä–æ–¥ {s[0]}, –≤—ã–±—Ä–∞–≤ - {s[1]}\n–æ—Ü–µ–Ω–∏—Ç–µ –∏–≥—Ä—É –æ—Ç 1 –¥–æ 5')
    context.user_data['isgame'] = 'wait number'


async def second_response(update, context):
    await update.message.reply_text(f"–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ! –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!")
    del context.user_data['isgame']
    del context.user_data['locality']


async def check_command(update, context):
    if 'isgame' in context.user_data:
        if context.user_data['isgame'] == 'wait town':
            await first_response(update, context)
        elif context.user_data['isgame'] == 'wait number':
            await second_response(update, context)
    elif update.message.text == 'üéÆ play üéÆ':
        await play(update, context)
    elif update.message.text == 'üìä statistics üìä':
        await stat(update, context)
    elif update.message.text == 'üìñ faq üìñ':
        await helpp(update, context)
    elif update.message.text == 'üö™ exit üö™':
        await close_keyboard(update, context)
    elif update.message.text == '‚öôÔ∏è settings ‚öôÔ∏è':
        await first_key_buttons(update, context)


async def button(update, context):
    query = update.callback_query

    await query.answer()

    answer = str(query.data)

    if answer == "—Å—Ç–∞—Ç–∞":
        await query.edit_message_text(text="vot tebe stata")
    elif answer == "–¥–∞–ª–µ–µ":
        await second_key_buttons(update, context, 2)
    elif answer == '–Ω–∞–∑–∞–¥':
        await second_key_buttons(update, context, 1)
    return context


async def first_key_buttons(update, context):
    keyboard = [
        [
            InlineKeyboardButton("—Å—Ç–∞—Ç–∞", callback_data='—Å—Ç–∞—Ç–∞'),
            InlineKeyboardButton("–¥–∞–ª–µ–µ", callback_data='–¥–∞–ª–µ–µ'),
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("1", reply_markup=reply_markup)
    return context


async def second_key_buttons(update, context, count):
    query = update.callback_query
    if count == 1:
        keyboard = [
            [
                InlineKeyboardButton("—Å—Ç–∞—Ç–∞", callback_data='—Å—Ç–∞—Ç–∞'),
                InlineKeyboardButton("–¥–∞–ª–µ–µ", callback_data='–¥–∞–ª–µ–µ'),
            ]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(text="1s", reply_markup=reply_markup)
    elif count == 2:
        keyboard = [
            [
                InlineKeyboardButton("–ø–æ–º–æ—â—å", callback_data="–ø–æ–º–æ—â—å"),
                InlineKeyboardButton("–Ω–∞–∑–∞–¥", callback_data='–Ω–∞–∑–∞–¥'),
            ]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(text="2", reply_markup=reply_markup)
    return context


def main():
    application = Application.builder().token('7198751024:AAF8hG5IUJq-BNMJ6BQ0FtH6kQgUDdT7C7I').build()

    application.add_handler(CommandHandler("start", start))

    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, check_command))

    application.add_handler(CallbackQueryHandler(button))

    application.run_polling()


if __name__ == '__main__':
    main()
